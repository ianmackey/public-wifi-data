<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Public WiFi Speed Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    @media (max-width: 768px) {
      body {
        padding: 8px;
        overflow-x: hidden;
      }
    }

    #wifi-map-container {
      font-size: 14px;
      max-width: 100%;
      overflow-x: hidden;
    }

    @media (max-width: 768px) {
      #wifi-map-container {
        font-size: 13px;
      }
    }
    
    #wifi-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    @media (max-width: 768px) {
      #wifi-controls {
        gap: 8px;
        margin-bottom: 8px;
        flex-direction: column;
        align-items: stretch;
      }

      #wifi-controls > * {
        width: 100%;
      }

      #wifi-controls label {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
    }
    
    #wifi-controls label {
      font-weight: 500;
    }
    
    #wifi-controls select,
    #wifi-controls input {
      padding: 6px 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      border-radius: 4px;
      background: inherit;
      color: inherit;
      font-size: 14px;
      min-height: 36px; /* Better touch target */
    }

    @media (max-width: 768px) {
      #wifi-controls select,
      #wifi-controls input {
        padding: 8px 12px;
        font-size: 16px; /* Prevents zoom on iOS */
        min-height: 44px; /* iOS recommended touch target */
      }
    }
    
    #wifi-controls input {
      width: 180px;
    }

    @media (max-width: 768px) {
      #wifi-controls input {
        width: 100%;
      }

      #wifi-controls select {
        width: 100%;
      }
    }
    
    #wifi-controls input::placeholder {
      color: rgba(127, 127, 127, 0.6);
    }
    
    #wifi-controls .search-wrapper {
      transition: opacity 0.2s ease;
    }
    
    #wifi-controls .search-wrapper.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    #wifi-map {
      height: calc(100vh - 180px);
      min-height: 500px;
      border-radius: 4px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      z-index: 0;
    }

    @media (max-width: 768px) {
      #wifi-map {
        height: calc(100vh - 120px);
        min-height: 400px;
      }
    }
    
    #wifi-map.hidden {
      display: none;
    }
    
    #wifi-table {
      display: none;
    }
    
    #wifi-table.visible {
      display: block;
    }
    
    #wifi-table {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    #wifi-table table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    @media (max-width: 768px) {
      #wifi-table th,
      #wifi-table td {
        padding: 6px;
        font-size: 12px;
      }

      #wifi-table th {
        font-size: 11px;
      }
    }
    
    #wifi-table th,
    #wifi-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(127, 127, 127, 0.25);
      text-align: left;
      vertical-align: top;
    }

    @media (max-width: 768px) {
      #wifi-table tbody tr {
        min-height: 44px; /* Better touch target */
      }
    }
    
    #wifi-table th {
      font-weight: 600;
      background: rgba(127, 127, 127, 0.18);
      border-bottom: 2px solid rgba(127, 127, 127, 0.35);
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }

    @media (max-width: 768px) {
      #wifi-table th {
        min-height: 44px; /* Better touch target */
        display: flex;
        align-items: center;
      }
    }
    
    #wifi-table th:hover {
      background: rgba(127, 127, 127, 0.28);
    }
    
    #wifi-table th .sort-indicator {
      margin-left: 4px;
      opacity: 0.5;
    }
    
    #wifi-table th.sorted .sort-indicator {
      opacity: 1;
    }
    
    #wifi-table a {
      color: inherit;
      text-decoration: underline;
    }
    
    .leaflet-popup-content {
      font-size: 13px;
      line-height: 1.4;
      margin: 12px;
    }

    @media (max-width: 768px) {
      .leaflet-popup-content {
        font-size: 12px;
        margin: 10px;
      }

      .popup-name {
        font-size: 13px;
      }

      .popup-category {
        font-size: 10px;
        padding: 2px 5px;
      }
    }
    
    .popup-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .popup-name a {
      color: inherit;
      text-decoration: underline;
    }
    
    .popup-speed {
      color: #2563eb;
      font-weight: 500;
    }

    .popup-category {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(127, 127, 127, 0.15);
      font-size: 11px;
      margin-bottom: 6px;
    }

    .popup-provider {
      color: #666;
      font-size: 11px;
      margin-top: 4px;
    }

    #speed-legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 4px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      font-size: 12px;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      user-select: none;
    }

    #speed-legend.collapsed {
      padding: 8px 12px;
    }

    #speed-legend.collapsed .legend-content {
      display: none;
    }

    #speed-legend .legend-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #speed-legend .legend-toggle {
      font-size: 10px;
      color: rgba(127, 127, 127, 0.8);
      transition: transform 0.2s ease;
    }

    #speed-legend.collapsed .legend-toggle {
      transform: rotate(-90deg);
    }

    @media (max-width: 768px) {
      #speed-legend {
        bottom: 10px;
        left: 10px;
        right: 10px;
        padding: 8px;
        font-size: 11px;
      }

      #speed-legend h3 {
        font-size: 11px;
        margin-bottom: 6px;
      }

      #speed-legend .legend-item {
        gap: 6px;
        margin-bottom: 3px;
      }

      #speed-legend .legend-dot {
        width: 10px;
        height: 10px;
      }
    }

    #speed-legend.hidden {
      display: none;
    }

    #speed-legend h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
    }

    #speed-legend .legend-content {
      margin-top: 8px;
    }

    #speed-legend .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    #speed-legend .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }


    #statistics-panel {
      margin-bottom: 12px;
      line-height: 1.6;
    }

    #wifi-list tbody tr,
    #wifi-table tbody tr {
      cursor: pointer;
      transition: background 0.15s ease;
    }

    #wifi-list tbody tr:hover,
    #wifi-table tbody tr:hover {
      background: rgba(127, 127, 127, 0.08);
    }

    .marker-highlighted {
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      }
      50% {
        transform: scale(1.2);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.3);
      }
    }

    .cluster-marker {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(37, 99, 235, 0.8);
      border: 3px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
    <div id="wifi-map-container">
    <div id="wifi-controls"></div>
    <div id="statistics-panel"></div>
    <div style="position: relative;">
      <div id="wifi-map"></div>
      <div id="speed-legend"></div>
    </div>
    <div id="wifi-table"></div>
  </div>

  <script>
  (async () => {
    const DATA_URL = "https://raw.githubusercontent.com/ianmackey/public-wifi-data/main/wifi-data.json";

    let map = null;
    let allData = [];
    let markerClusterGroup = null;
    let tableSortState = { column: null, direction: null };
    let dataMap = new Map(); // Map row data to markers for click-to-fly

    // ─────────────────────────────────────────────────────────────
    // Utilities
    // ─────────────────────────────────────────────────────────────
    function toNumber(value) {
      if (value == null) return null;
      const n = Number(String(value).replace(/,/g, ""));
      return Number.isFinite(n) ? n : null;
    }

    function formatNumber(value) {
      if (value === null) return "";
      return new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(value);
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return dateString;
      return `${d.getMonth() + 1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
    }

    function parseDate(dateString) {
      const d = new Date(dateString);
      return isNaN(d.getTime()) ? null : d;
    }

    function getSpeedColor(download) {
      if (download >= 100) return "#22c55e";
      if (download >= 50) return "#84cc16";
      if (download >= 25) return "#eab308";
      if (download >= 10) return "#f97316";
      return "#ef4444";
    }

    // ─────────────────────────────────────────────────────────────
    // Data filtering & sorting
    // ─────────────────────────────────────────────────────────────
    function filterData(data) {
      // Always show location-based data (exclude airlines which don't have coordinates)
      let filtered = data.filter(row => row.Category !== "Airline" && row.Latitude != null && row.Longitude != null);
      
      // Deduplicate: keep only the most recent entry for each location
      // Use Name + Latitude + Longitude as unique key
      const locationMap = new Map();
      
      filtered.forEach(row => {
        const key = `${row.Name || ""}_${row.Latitude}_${row.Longitude}`;
        const existing = locationMap.get(key);
        
        if (!existing) {
          locationMap.set(key, row);
        } else {
          // Compare dates - keep the most recent
          const existingDate = parseDate(existing["Date Measured"]);
          const currentDate = parseDate(row["Date Measured"]);
          
          if (currentDate && existingDate) {
            if (currentDate > existingDate) {
              locationMap.set(key, row);
            }
          } else if (currentDate && !existingDate) {
            locationMap.set(key, row);
          }
        }
      });
      
      return Array.from(locationMap.values());
    }

    function sortData(data, column, direction) {
      if (!column) {
        return [...data].sort((a, b) => {
          const dateA = parseDate(a["Date Measured"]);
          const dateB = parseDate(b["Date Measured"]);
          if (!dateA && !dateB) return 0;
          if (!dateA) return 1;
          if (!dateB) return -1;
          return dateB - dateA;
        });
      }

      const numericColumns = ["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"];
      const isNumeric = numericColumns.includes(column);

      return [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        if (isNumeric) {
          valA = toNumber(valA);
          valB = toNumber(valB);
          if (valA === null && valB === null) return 0;
          if (valA === null) return 1;
          if (valB === null) return -1;
        } else {
          valA = valA || "";
          valB = valB || "";
        }

        if (valA < valB) return direction === "asc" ? -1 : 1;
        if (valA > valB) return direction === "asc" ? 1 : -1;
        return 0;
      });
    }

    // ─────────────────────────────────────────────────────────────
    // Map functions
    // ─────────────────────────────────────────────────────────────
    function clearMarkers() {
      if (markerClusterGroup) {
        map.removeLayer(markerClusterGroup);
        markerClusterGroup = null;
      }
      dataMap.clear();
    }

    function createPopupHTML(row) {
      const download = toNumber(row["Download (Mbps)"]) || 0;
      const upload = toNumber(row["Upload (Mbps)"]) || 0;
      const latency = toNumber(row["Latency (ms)"]);
      const nameHtml = row.Website 
        ? `<a href="${row.Website}" target="_blank" rel="noopener noreferrer">${row.Name || "Unknown"}</a>`
        : (row.Name || "Unknown");
      const categoryBadge = row.Category 
        ? `<div class="popup-category">${row.Category}</div>`
        : "";
      const providerInfo = row.Provider 
        ? `<div class="popup-provider">Provider: ${row.Provider}</div>`
        : "";

      return `
        <div class="popup-name">${nameHtml}</div>
        ${categoryBadge}
        <div>${row.Address || ""}</div>
        <div class="popup-speed">↓ ${formatNumber(download)} Mbps</div>
        <div>↑ ${formatNumber(upload)} Mbps</div>
        <div>Latency: ${latency !== null ? formatNumber(latency) + " ms" : "N/A"}</div>
        ${providerInfo}
        <div style="color: #666; font-size: 11px; margin-top: 4px;">Date measured: ${formatDate(row["Date Measured"])}</div>
      `;
    }

    function addMarkers(data) {
      if (!map) return;

      clearMarkers();

      // Create marker cluster group
      markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
      });

      const bounds = L.latLngBounds([]);
      const markers = [];

      data.forEach(row => {
        const lat = toNumber(row.Latitude);
        const lng = toNumber(row.Longitude);
        if (lat === null || lng === null) return;

        const download = toNumber(row["Download (Mbps)"]) || 0;
        const color = getSpeedColor(download);

        // Create custom icon
        const icon = L.divIcon({
          className: 'wifi-marker',
          html: `<div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${color}; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        });

        // Create marker
        const marker = L.marker([lat, lng], { icon: icon });
        
        // Bind popup
        marker.bindPopup(createPopupHTML(row));
        
        // Store mapping for click-to-fly
        dataMap.set(row, marker);
        
        markers.push(marker);
        bounds.extend([lat, lng]);
      });

      if (markers.length === 0) return;

      // Add markers to cluster group
      markerClusterGroup.addLayers(markers);
      map.addLayer(markerClusterGroup);

      // Fit bounds
      if (markers.length > 0) {
        map.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });
      }
    }

    function flyToLocation(row) {
      const lat = toNumber(row.Latitude);
      const lng = toNumber(row.Longitude);
      if (lat === null || lng === null) return;

      // Fly to location
      map.flyTo([lat, lng], 15, {
        duration: 1.0
      });

      // Show popup after fly animation
      setTimeout(() => {
        const marker = dataMap.get(row);
        if (marker) {
          marker.openPopup();
        }
      }, 1100);
    }

    async function searchLocation(query) {
      if (!query) {
        const filtered = filterData(allData);
        addMarkers(filtered);
        return;
      }

      try {
        // Use Nominatim (OpenStreetMap geocoding) - free and no API key required
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`,
          {
            headers: {
              'User-Agent': 'Public WiFi Speed Map'
            }
          }
        );
        const result = await response.json();

        if (result && result.length > 0) {
          const lat = parseFloat(result[0].lat);
          const lng = parseFloat(result[0].lon);
          map.flyTo([lat, lng], 11, { duration: 1.0 });
        }
      } catch (err) {
        console.error("Geocoding error:", err);
      }
    }


    // ─────────────────────────────────────────────────────────────
    // Airline table
    // ─────────────────────────────────────────────────────────────
    function renderTable(data) {
      const tableContainer = document.getElementById("wifi-table");
      const columns = ["Airline", "Route", "Aircraft Type", "Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Date Measured"];
      
      const sortedData = sortData(data, tableSortState.column, tableSortState.direction);

      const table = document.createElement("table");
      
      // Header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      columns.forEach(col => {
        const th = document.createElement("th");
        th.dataset.column = col;
        
        const text = document.createElement("span");
        text.textContent = col;
        th.appendChild(text);

        const indicator = document.createElement("span");
        indicator.className = "sort-indicator";
        indicator.textContent = "⇅";
        th.appendChild(indicator);

        if (tableSortState.column === col) {
          th.classList.add("sorted");
          indicator.textContent = tableSortState.direction === "asc" ? "↑" : "↓";
        }

        th.addEventListener("click", () => {
          if (tableSortState.column === col) {
            if (tableSortState.direction === "asc") {
              tableSortState.direction = "desc";
            } else {
              tableSortState = { column: null, direction: null };
            }
          } else {
            tableSortState = { column: col, direction: "asc" };
          }
          renderTable(data);
        });

        headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement("tbody");
      
      sortedData.forEach(row => {
        const tr = document.createElement("tr");
        
        columns.forEach(col => {
          const td = document.createElement("td");
          
          if (col === "Airline" && row.Website) {
            const a = document.createElement("a");
            a.href = row.Website;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = row[col] || "";
            td.appendChild(a);
          } else if (col === "Date Measured") {
            td.textContent = formatDate(row[col]);
          } else if (["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"].includes(col)) {
            const val = toNumber(row[col]);
            td.textContent = val !== null ? formatNumber(val) : "N/A";
          } else {
            td.textContent = row[col] || "";
          }
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      
      tableContainer.innerHTML = "";
      tableContainer.appendChild(table);
    }

    // ─────────────────────────────────────────────────────────────
    // View switching
    // ─────────────────────────────────────────────────────────────
    function updateView() {
      const mapEl = document.getElementById("wifi-map");
      const searchWrapper = document.querySelector(".search-wrapper");
      const legendEl = document.getElementById("speed-legend");
      
      const filtered = filterData(allData);

      // Update statistics
      updateStatistics(filtered);

      // Always show map with location-based data
      searchWrapper?.classList.remove("hidden");
      if (legendEl) legendEl.classList.remove("hidden");
      mapEl.classList.remove("hidden");
      addMarkers(filtered);
    }

    function updateStatistics(data) {
      const statsPanel = document.getElementById("statistics-panel");
      if (!statsPanel) return;

      const locationData = data.filter(row => row.Latitude != null && row.Longitude != null);
      const downloads = locationData.map(row => toNumber(row["Download (Mbps)"])).filter(v => v !== null);
      const uploads = locationData.map(row => toNumber(row["Upload (Mbps)"])).filter(v => v !== null);

      const avgDownload = downloads.length > 0 
        ? downloads.reduce((a, b) => a + b, 0) / downloads.length 
        : 0;
      const avgUpload = uploads.length > 0 
        ? uploads.reduce((a, b) => a + b, 0) / uploads.length 
        : 0;
      const maxDownload = downloads.length > 0 ? Math.max(...downloads) : 0;
      const minDownload = downloads.length > 0 ? Math.min(...downloads) : 0;

      // Find the most recent measurement date
      const dates = locationData
        .map(row => parseDate(row["Date Measured"]))
        .filter(date => date !== null);
      const lastDate = dates.length > 0 
        ? new Date(Math.max(...dates))
        : null;
      const lastDateFormatted = lastDate ? formatDate(lastDate.toISOString().split('T')[0]) : '';

      statsPanel.innerHTML = `
        I've measured ${locationData.length} location${locationData.length !== 1 ? 's' : ''}${lastDateFormatted ? ` (last measured: ${lastDateFormatted})` : ''}. Average download speed: ${formatNumber(avgDownload)} Mbps, average upload speed: ${formatNumber(avgUpload)} Mbps. Top speed: ${formatNumber(maxDownload)} Mbps, slowest: ${formatNumber(minDownload)} Mbps.
      `;
    }

    function createSpeedLegend() {
      const legend = document.getElementById("speed-legend");
      if (!legend) return;

      // Start collapsed by default
      legend.classList.add("collapsed");

      legend.innerHTML = `
        <div class="legend-header">
          <h3>Download Speed</h3>
          <span class="legend-toggle">▼</span>
        </div>
        <div class="legend-content">
          <div class="legend-item">
            <div class="legend-dot" style="background-color: #22c55e;"></div>
            <span>≥ 100 Mbps</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background-color: #84cc16;"></div>
            <span>50 - 99 Mbps</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background-color: #eab308;"></div>
            <span>25 - 49 Mbps</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background-color: #f97316;"></div>
            <span>10 - 24 Mbps</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background-color: #ef4444;"></div>
            <span>&lt; 10 Mbps</span>
          </div>
        </div>
      `;

      // Add click handler to toggle
      legend.addEventListener("click", () => {
        legend.classList.toggle("collapsed");
      });
    }

    // ─────────────────────────────────────────────────────────────
    // Controls
    // ─────────────────────────────────────────────────────────────
    function createControls() {
      const controls = document.getElementById("wifi-controls");
      
      // Search input
      const searchWrapper = document.createElement("div");
      searchWrapper.className = "search-wrapper";
      
      const searchLabel = document.createElement("label");
      searchLabel.textContent = "Search: ";
      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = "City or zip code...";
      searchInput.id = "location-search";

      let debounceTimer;
      searchInput.addEventListener("input", (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchLocation(e.target.value.trim());
        }, 400);
      });

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          clearTimeout(debounceTimer);
          searchLocation(e.target.value.trim());
        }
      });

      searchLabel.appendChild(searchInput);
      searchWrapper.appendChild(searchLabel);
      controls.appendChild(searchWrapper);
    }

    // ─────────────────────────────────────────────────────────────
    // Initialize
    // ─────────────────────────────────────────────────────────────
    try {
      const response = await fetch(DATA_URL + "?t=" + Date.now(), { cache: "no-store" });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      allData = await response.json();

      // Initialize Leaflet map
      map = L.map('wifi-map', {
        center: [20, 0],
        zoom: 1,
        zoomControl: true
      });

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      // Move zoom control to top-right
      map.zoomControl.setPosition('topright');

      createControls();
      createSpeedLegend();

      // Initialize view
      updateView();

    } catch (err) {
      document.getElementById("wifi-map").textContent = `Error: ${err.message}`;
    }
  })();
  </script>
</body>
</html>

