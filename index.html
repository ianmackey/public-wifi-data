<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Public WiFi Speed Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: transparent;
    }

    #wifi-map-container {
      font-size: 14px;
    }
    
    #wifi-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    #wifi-controls label {
      font-weight: 500;
    }
    
    #wifi-controls select,
    #wifi-controls input {
      padding: 6px 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      border-radius: 4px;
      background: inherit;
      color: inherit;
      font-size: 14px;
    }
    
    #wifi-controls input {
      width: 180px;
    }
    
    #wifi-controls input::placeholder {
      color: rgba(127, 127, 127, 0.6);
    }
    
    #wifi-controls .search-wrapper,
    #wifi-controls .view-toggle-wrapper {
      transition: opacity 0.2s ease;
    }
    
    #wifi-controls .search-wrapper.hidden,
    #wifi-controls .view-toggle-wrapper.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .view-toggle {
      display: flex;
      gap: 0;
    }
    
    .view-toggle button {
      padding: 6px 12px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: inherit;
      color: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .view-toggle button:first-child {
      border-radius: 4px 0 0 4px;
      border-right: none;
    }
    
    .view-toggle button:last-child {
      border-radius: 0 4px 4px 0;
    }
    
    .view-toggle button.active {
      background: rgba(127, 127, 127, 0.25);
      font-weight: 600;
    }
    
    .view-toggle button:hover:not(.active) {
      background: rgba(127, 127, 127, 0.12);
    }
    
    #wifi-map {
      height: 400px;
      border-radius: 4px;
      border: 1px solid rgba(127, 127, 127, 0.35);
    }
    
    #wifi-map.hidden {
      display: none;
    }
    
    #wifi-list {
      display: none;
    }
    
    #wifi-list.visible {
      display: block;
    }
    
    #wifi-list table {
      width: 100%;
      border-collapse: collapse;
    }
    
    #wifi-list th,
    #wifi-list td {
      padding: 8px;
      border-bottom: 1px solid rgba(127, 127, 127, 0.25);
      text-align: left;
      vertical-align: top;
    }
    
    #wifi-list th {
      font-weight: 600;
      background: rgba(127, 127, 127, 0.18);
      border-bottom: 2px solid rgba(127, 127, 127, 0.35);
      cursor: pointer;
      user-select: none;
    }
    
    #wifi-list th:hover {
      background: rgba(127, 127, 127, 0.28);
    }
    
    #wifi-list th .sort-indicator {
      margin-left: 4px;
      opacity: 0.5;
    }
    
    #wifi-list th.sorted .sort-indicator {
      opacity: 1;
    }
    
    #wifi-list a {
      color: inherit;
      text-decoration: underline;
    }
    
    #wifi-list .speed-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    
    #wifi-table {
      display: none;
    }
    
    #wifi-table.visible {
      display: block;
    }
    
    #wifi-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    #wifi-table th,
    #wifi-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(127, 127, 127, 0.25);
      text-align: left;
      vertical-align: top;
    }
    
    #wifi-table th {
      font-weight: 600;
      background: rgba(127, 127, 127, 0.18);
      border-bottom: 2px solid rgba(127, 127, 127, 0.35);
      cursor: pointer;
      user-select: none;
    }
    
    #wifi-table th:hover {
      background: rgba(127, 127, 127, 0.28);
    }
    
    #wifi-table th .sort-indicator {
      margin-left: 4px;
      opacity: 0.5;
    }
    
    #wifi-table th.sorted .sort-indicator {
      opacity: 1;
    }
    
    #wifi-table a {
      color: inherit;
      text-decoration: underline;
    }
    
    #wifi-map .mapboxgl-popup-content {
      font-size: 13px;
      line-height: 1.4;
      padding: 12px;
      border-radius: 4px;
    }
    
    .popup-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .popup-name a {
      color: inherit;
      text-decoration: underline;
    }
    
    .popup-speed {
      color: #2563eb;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="wifi-map-container">
    <div id="wifi-controls"></div>
    <div id="wifi-map"></div>
    <div id="wifi-list"></div>
    <div id="wifi-table"></div>
  </div>

  <script>
  (async () => {
    const DATA_URL = "https://raw.githubusercontent.com/ianmackey/public-wifi-data/main/wifi-data.json";
    const MAPBOX_TOKEN = "pk.eyJ1IjoibWFja2V5aWFuIiwiYSI6ImNta2JwODMxZzA2aTczZXB4emJqMjdlcGEifQ.u0jdDVrE8sHrew7G5NPteQ";
    
    mapboxgl.accessToken = MAPBOX_TOKEN;

    let map = null;
    let allData = [];
    let markers = [];
    let currentCategory = "all";
    let currentView = "map"; // "map" or "list"
    let listSortState = { column: null, direction: null };
    let tableSortState = { column: null, direction: null };

    // ─────────────────────────────────────────────────────────────
    // Utilities
    // ─────────────────────────────────────────────────────────────
    function toNumber(value) {
      if (value == null) return null;
      const n = Number(String(value).replace(/,/g, ""));
      return Number.isFinite(n) ? n : null;
    }

    function formatNumber(value) {
      if (value === null) return "";
      return new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(value);
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return dateString;
      return `${d.getMonth() + 1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
    }

    function parseDate(dateString) {
      const d = new Date(dateString);
      return isNaN(d.getTime()) ? null : d;
    }

    function getSpeedColor(download) {
      if (download >= 100) return "#22c55e";
      if (download >= 50) return "#84cc16";
      if (download >= 25) return "#eab308";
      if (download >= 10) return "#f97316";
      return "#ef4444";
    }

    function getCategories(data) {
      const categories = new Set(data.map(row => row.Category).filter(Boolean));
      return Array.from(categories).sort();
    }

    function isAirlineCategory(category) {
      return category === "Airline";
    }

    // ─────────────────────────────────────────────────────────────
    // Data filtering & sorting
    // ─────────────────────────────────────────────────────────────
    function filterData(data, category) {
      if (category === "all") {
        return data.filter(row => row.Category !== "Airline" && row.Latitude != null && row.Longitude != null);
      }
      if (isAirlineCategory(category)) {
        return data.filter(row => row.Category === "Airline");
      }
      return data.filter(row => row.Category === category && row.Latitude != null && row.Longitude != null);
    }

    function sortData(data, column, direction) {
      if (!column) {
        return [...data].sort((a, b) => {
          const dateA = parseDate(a["Date Measured"]);
          const dateB = parseDate(b["Date Measured"]);
          if (!dateA && !dateB) return 0;
          if (!dateA) return 1;
          if (!dateB) return -1;
          return dateB - dateA;
        });
      }

      const numericColumns = ["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"];
      const isNumeric = numericColumns.includes(column);

      return [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        if (isNumeric) {
          valA = toNumber(valA);
          valB = toNumber(valB);
          if (valA === null && valB === null) return 0;
          if (valA === null) return 1;
          if (valB === null) return -1;
        } else {
          valA = valA || "";
          valB = valB || "";
        }

        if (valA < valB) return direction === "asc" ? -1 : 1;
        if (valA > valB) return direction === "asc" ? 1 : -1;
        return 0;
      });
    }

    // ─────────────────────────────────────────────────────────────
    // Map functions
    // ─────────────────────────────────────────────────────────────
    function clearMarkers() {
      markers.forEach(m => m.remove());
      markers = [];
    }

    function addMarkers(data) {
      clearMarkers();
      const bounds = new mapboxgl.LngLatBounds();

      data.forEach(row => {
        const lat = toNumber(row.Latitude);
        const lng = toNumber(row.Longitude);
        if (lat === null || lng === null) return;

        const download = toNumber(row["Download (Mbps)"]) || 0;
        const color = getSpeedColor(download);

        const el = document.createElement("div");
        el.style.cssText = `
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background-color: ${color};
          border: 2px solid #fff;
          box-shadow: 0 1px 3px rgba(0,0,0,0.3);
          cursor: pointer;
        `;

        const nameHtml = row.Website 
          ? `<a href="${row.Website}" target="_blank" rel="noopener noreferrer">${row.Name || "Unknown"}</a>`
          : (row.Name || "Unknown");

        const popup = new mapboxgl.Popup({ offset: 12 }).setHTML(`
          <div class="popup-name">${nameHtml}</div>
          <div>${row.Address || ""}</div>
          <div class="popup-speed">↓ ${formatNumber(download)} Mbps</div>
          <div>↑ ${formatNumber(toNumber(row["Upload (Mbps)"]))} Mbps</div>
          <div>Latency: ${formatNumber(toNumber(row["Latency (ms)"]))} ms</div>
          <div style="color: #666; font-size: 11px; margin-top: 4px;">${formatDate(row["Date Measured"])}</div>
        `);

        const marker = new mapboxgl.Marker(el)
          .setLngLat([lng, lat])
          .setPopup(popup)
          .addTo(map);

        markers.push(marker);
        bounds.extend([lng, lat]);
      });

      if (data.length > 0) {
        map.fitBounds(bounds, { padding: 40, maxZoom: 12 });
      }
    }

    async function searchLocation(query) {
      if (!query) {
        const filtered = filterData(allData, currentCategory);
        if (currentView === "map") {
          addMarkers(filtered);
        }
        return;
      }

      try {
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&limit=1`
        );
        const result = await response.json();

        if (result.features && result.features.length > 0) {
          const [lng, lat] = result.features[0].center;
          
          if (currentView === "map") {
            map.flyTo({ center: [lng, lat], zoom: 11 });
          } else {
            // For list view, we could filter by proximity - for now just switch to map
            currentView = "map";
            updateViewToggle();
            updateView();
            map.flyTo({ center: [lng, lat], zoom: 11 });
          }
        }
      } catch (err) {
        console.error("Geocoding error:", err);
      }
    }

    // ─────────────────────────────────────────────────────────────
    // List view (for location-based data)
    // ─────────────────────────────────────────────────────────────
    function renderList(data) {
      const listContainer = document.getElementById("wifi-list");
      const columns = ["Name", "Category", "Address", "Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Date Measured"];
      
      const sortedData = sortData(data, listSortState.column, listSortState.direction);

      const table = document.createElement("table");
      
      // Header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      columns.forEach(col => {
        const th = document.createElement("th");
        th.dataset.column = col;
        
        const text = document.createElement("span");
        text.textContent = col;
        th.appendChild(text);

        const indicator = document.createElement("span");
        indicator.className = "sort-indicator";
        indicator.textContent = "⇅";
        th.appendChild(indicator);

        if (listSortState.column === col) {
          th.classList.add("sorted");
          indicator.textContent = listSortState.direction === "asc" ? "↑" : "↓";
        }

        th.addEventListener("click", () => {
          if (listSortState.column === col) {
            if (listSortState.direction === "asc") {
              listSortState.direction = "desc";
            } else {
              listSortState = { column: null, direction: null };
            }
          } else {
            listSortState = { column: col, direction: "asc" };
          }
          renderList(data);
        });

        headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement("tbody");
      
      sortedData.forEach(row => {
        const tr = document.createElement("tr");
        
        columns.forEach(col => {
          const td = document.createElement("td");
          
          if (col === "Name") {
            const download = toNumber(row["Download (Mbps)"]) || 0;
            const dot = document.createElement("span");
            dot.className = "speed-dot";
            dot.style.backgroundColor = getSpeedColor(download);
            td.appendChild(dot);
            
            if (row.Website) {
              const a = document.createElement("a");
              a.href = row.Website;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.textContent = row[col] || "";
              td.appendChild(a);
            } else {
              td.appendChild(document.createTextNode(row[col] || ""));
            }
          } else if (col === "Date Measured") {
            td.textContent = formatDate(row[col]);
          } else if (["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"].includes(col)) {
            td.textContent = formatNumber(toNumber(row[col]));
          } else {
            td.textContent = row[col] || "";
          }
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      
      listContainer.innerHTML = "";
      listContainer.appendChild(table);
    }

    // ─────────────────────────────────────────────────────────────
    // Airline table
    // ─────────────────────────────────────────────────────────────
    function renderTable(data) {
      const tableContainer = document.getElementById("wifi-table");
      const columns = ["Airline", "Route", "Aircraft Type", "Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Date Measured"];
      
      const sortedData = sortData(data, tableSortState.column, tableSortState.direction);

      const table = document.createElement("table");
      
      // Header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      columns.forEach(col => {
        const th = document.createElement("th");
        th.dataset.column = col;
        
        const text = document.createElement("span");
        text.textContent = col;
        th.appendChild(text);

        const indicator = document.createElement("span");
        indicator.className = "sort-indicator";
        indicator.textContent = "⇅";
        th.appendChild(indicator);

        if (tableSortState.column === col) {
          th.classList.add("sorted");
          indicator.textContent = tableSortState.direction === "asc" ? "↑" : "↓";
        }

        th.addEventListener("click", () => {
          if (tableSortState.column === col) {
            if (tableSortState.direction === "asc") {
              tableSortState.direction = "desc";
            } else {
              tableSortState = { column: null, direction: null };
            }
          } else {
            tableSortState = { column: col, direction: "asc" };
          }
          renderTable(data);
        });

        headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement("tbody");
      
      sortedData.forEach(row => {
        const tr = document.createElement("tr");
        
        columns.forEach(col => {
          const td = document.createElement("td");
          
          if (col === "Airline" && row.Website) {
            const a = document.createElement("a");
            a.href = row.Website;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = row[col] || "";
            td.appendChild(a);
          } else if (col === "Date Measured") {
            td.textContent = formatDate(row[col]);
          } else if (["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"].includes(col)) {
            td.textContent = formatNumber(toNumber(row[col]));
          } else {
            td.textContent = row[col] || "";
          }
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      
      tableContainer.innerHTML = "";
      tableContainer.appendChild(table);
    }

    // ─────────────────────────────────────────────────────────────
    // View switching
    // ─────────────────────────────────────────────────────────────
    function updateViewToggle() {
      const mapBtn = document.getElementById("view-map-btn");
      const listBtn = document.getElementById("view-list-btn");
      
      if (mapBtn && listBtn) {
        mapBtn.classList.toggle("active", currentView === "map");
        listBtn.classList.toggle("active", currentView === "list");
      }
    }

    function updateView() {
      const mapEl = document.getElementById("wifi-map");
      const listEl = document.getElementById("wifi-list");
      const tableEl = document.getElementById("wifi-table");
      const searchWrapper = document.querySelector(".search-wrapper");
      const viewToggleWrapper = document.querySelector(".view-toggle-wrapper");
      
      const filtered = filterData(allData, currentCategory);

      if (isAirlineCategory(currentCategory)) {
        // Airline view: show table only
        mapEl.classList.add("hidden");
        listEl.classList.remove("visible");
        tableEl.classList.add("visible");
        searchWrapper?.classList.add("hidden");
        viewToggleWrapper?.classList.add("hidden");
        clearMarkers();
        renderTable(filtered);
      } else {
        // Location-based view: show map or list
        tableEl.classList.remove("visible");
        searchWrapper?.classList.remove("hidden");
        viewToggleWrapper?.classList.remove("hidden");
        
        if (currentView === "map") {
          mapEl.classList.remove("hidden");
          listEl.classList.remove("visible");
          addMarkers(filtered);
        } else {
          mapEl.classList.add("hidden");
          listEl.classList.add("visible");
          clearMarkers();
          renderList(filtered);
        }
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Controls
    // ─────────────────────────────────────────────────────────────
    function createControls(categories) {
      const controls = document.getElementById("wifi-controls");
      
      // Category filter
      const filterLabel = document.createElement("label");
      filterLabel.textContent = "Filter: ";
      const select = document.createElement("select");
      select.id = "category-filter";

      const allOption = document.createElement("option");
      allOption.value = "all";
      allOption.textContent = "All";
      select.appendChild(allOption);

      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });

      select.addEventListener("change", (e) => {
        currentCategory = e.target.value;
        listSortState = { column: null, direction: null };
        tableSortState = { column: null, direction: null };
        if (!isAirlineCategory(currentCategory)) {
          currentView = "map"; // Reset to map when switching categories
        }
        updateViewToggle();
        updateView();
      });

      filterLabel.appendChild(select);
      controls.appendChild(filterLabel);

      // View toggle (Map / List)
      const viewToggleWrapper = document.createElement("div");
      viewToggleWrapper.className = "view-toggle-wrapper";
      
      const viewToggle = document.createElement("div");
      viewToggle.className = "view-toggle";
      
      const mapBtn = document.createElement("button");
      mapBtn.id = "view-map-btn";
      mapBtn.textContent = "Map";
      mapBtn.className = "active";
      mapBtn.addEventListener("click", () => {
        if (currentView !== "map") {
          currentView = "map";
          updateViewToggle();
          updateView();
        }
      });
      
      const listBtn = document.createElement("button");
      listBtn.id = "view-list-btn";
      listBtn.textContent = "List";
      listBtn.addEventListener("click", () => {
        if (currentView !== "list") {
          currentView = "list";
          updateViewToggle();
          updateView();
        }
      });
      
      viewToggle.appendChild(mapBtn);
      viewToggle.appendChild(listBtn);
      viewToggleWrapper.appendChild(viewToggle);
      controls.appendChild(viewToggleWrapper);

      // Search input
      const searchWrapper = document.createElement("div");
      searchWrapper.className = "search-wrapper";
      
      const searchLabel = document.createElement("label");
      searchLabel.textContent = "Search: ";
      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = "City or zip code...";
      searchInput.id = "location-search";

      let debounceTimer;
      searchInput.addEventListener("input", (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchLocation(e.target.value.trim());
        }, 400);
      });

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          clearTimeout(debounceTimer);
          searchLocation(e.target.value.trim());
        }
      });

      searchLabel.appendChild(searchInput);
      searchWrapper.appendChild(searchLabel);
      controls.appendChild(searchWrapper);
    }

    // ─────────────────────────────────────────────────────────────
    // Initialize
    // ─────────────────────────────────────────────────────────────
    try {
      const response = await fetch(DATA_URL + "?t=" + Date.now(), { cache: "no-store" });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      allData = await response.json();

      map = new mapboxgl.Map({
        container: "wifi-map",
        style: "mapbox://styles/mapbox/light-v11",
        center: [0, 20],
        zoom: 1
      });

      map.addControl(new mapboxgl.NavigationControl(), "top-right");

      createControls(getCategories(allData));
      updateView();

    } catch (err) {
      document.getElementById("wifi-map").textContent = `Error: ${err.message}`;
    }
  })();
  </script>
</body>
</html>

