<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Public WiFi Speed Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: transparent;
    }

    #wifi-map-container {
      font-size: 14px;
    }
    
    #wifi-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    #wifi-controls label {
      font-weight: 500;
    }
    
    #wifi-controls select,
    #wifi-controls input {
      padding: 6px 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      border-radius: 4px;
      background: inherit;
      color: inherit;
      font-size: 14px;
    }
    
    #wifi-controls input {
      width: 180px;
    }
    
    #wifi-controls input::placeholder {
      color: rgba(127, 127, 127, 0.6);
    }
    
    #wifi-controls .search-wrapper,
    #wifi-controls .view-toggle-wrapper {
      transition: opacity 0.2s ease;
    }
    
    #wifi-controls .search-wrapper.hidden,
    #wifi-controls .view-toggle-wrapper.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .view-toggle {
      display: flex;
      gap: 0;
    }
    
    .view-toggle button {
      padding: 6px 12px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: inherit;
      color: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .view-toggle button:first-child {
      border-radius: 4px 0 0 4px;
      border-right: none;
    }
    
    .view-toggle button:last-child {
      border-radius: 0 4px 4px 0;
    }
    
    .view-toggle button.active {
      background: rgba(127, 127, 127, 0.25);
      font-weight: 600;
    }
    
    .view-toggle button:hover:not(.active) {
      background: rgba(127, 127, 127, 0.12);
    }
    
    #wifi-map {
      height: calc(100vh - 280px);
      min-height: 400px;
      border-radius: 4px;
      border: 1px solid rgba(127, 127, 127, 0.35);
    }
    
    #wifi-map.hidden {
      display: none;
    }
    
    #wifi-list {
      display: none;
    }
    
    #wifi-list.visible {
      display: block;
    }
    
    #wifi-list table {
      width: 100%;
      border-collapse: collapse;
    }
    
    #wifi-list th,
    #wifi-list td {
      padding: 8px;
      border-bottom: 1px solid rgba(127, 127, 127, 0.25);
      text-align: left;
      vertical-align: top;
    }
    
    #wifi-list th {
      font-weight: 600;
      background: rgba(127, 127, 127, 0.18);
      border-bottom: 2px solid rgba(127, 127, 127, 0.35);
      cursor: pointer;
      user-select: none;
    }
    
    #wifi-list th:hover {
      background: rgba(127, 127, 127, 0.28);
    }
    
    #wifi-list th .sort-indicator {
      margin-left: 4px;
      opacity: 0.5;
    }
    
    #wifi-list th.sorted .sort-indicator {
      opacity: 1;
    }
    
    #wifi-list a {
      color: inherit;
      text-decoration: underline;
    }
    
    #wifi-list .speed-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    
    #wifi-table {
      display: none;
    }
    
    #wifi-table.visible {
      display: block;
    }
    
    #wifi-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    #wifi-table th,
    #wifi-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(127, 127, 127, 0.25);
      text-align: left;
      vertical-align: top;
    }
    
    #wifi-table th {
      font-weight: 600;
      background: rgba(127, 127, 127, 0.18);
      border-bottom: 2px solid rgba(127, 127, 127, 0.35);
      cursor: pointer;
      user-select: none;
    }
    
    #wifi-table th:hover {
      background: rgba(127, 127, 127, 0.28);
    }
    
    #wifi-table th .sort-indicator {
      margin-left: 4px;
      opacity: 0.5;
    }
    
    #wifi-table th.sorted .sort-indicator {
      opacity: 1;
    }
    
    #wifi-table a {
      color: inherit;
      text-decoration: underline;
    }
    
    #wifi-map .mapboxgl-popup-content {
      font-size: 13px;
      line-height: 1.4;
      padding: 12px;
      border-radius: 4px;
    }
    
    .popup-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .popup-name a {
      color: inherit;
      text-decoration: underline;
    }
    
    .popup-speed {
      color: #2563eb;
      font-weight: 500;
    }

    .popup-category {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(127, 127, 127, 0.15);
      font-size: 11px;
      margin-bottom: 6px;
    }

    .popup-provider {
      color: #666;
      font-size: 11px;
      margin-top: 4px;
    }

    #speed-legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 4px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      font-size: 12px;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #speed-legend.hidden {
      display: none;
    }

    #speed-legend h3 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 600;
    }

    #speed-legend .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    #speed-legend .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    #speed-range-filter {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 200px;
    }

    #speed-range-filter input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: rgba(127, 127, 127, 0.2);
      outline: none;
      -webkit-appearance: none;
    }

    #speed-range-filter input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #2563eb;
      cursor: pointer;
    }

    #speed-range-filter input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #2563eb;
      cursor: pointer;
      border: none;
    }

    #speed-range-filter .range-values {
      font-size: 12px;
      min-width: 80px;
      text-align: right;
    }

    #statistics-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .stat-card {
      padding: 12px;
      border-radius: 4px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: rgba(127, 127, 127, 0.08);
    }

    .stat-card .stat-label {
      font-size: 11px;
      color: rgba(127, 127, 127, 0.8);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .stat-value {
      font-size: 20px;
      font-weight: 600;
    }

    #wifi-list tbody tr,
    #wifi-table tbody tr {
      cursor: pointer;
      transition: background 0.15s ease;
    }

    #wifi-list tbody tr:hover,
    #wifi-table tbody tr:hover {
      background: rgba(127, 127, 127, 0.08);
    }

    .marker-highlighted {
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      }
      50% {
        transform: scale(1.2);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.3);
      }
    }

    .cluster-marker {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(37, 99, 235, 0.8);
      border: 3px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="wifi-map-container">
    <div id="wifi-controls"></div>
    <div id="statistics-panel"></div>
    <div style="position: relative;">
      <div id="wifi-map"></div>
      <div id="speed-legend"></div>
    </div>
    <div id="wifi-list"></div>
    <div id="wifi-table"></div>
  </div>

  <script>
  (async () => {
    const DATA_URL = "https://raw.githubusercontent.com/ianmackey/public-wifi-data/main/wifi-data.json";
    const MAPBOX_TOKEN = "pk.eyJ1IjoibWFja2V5aWFuIiwiYSI6ImNta2JwODMxZzA2aTczZXB4emJqMjdlcGEifQ.u0jdDVrE8sHrew7G5NPteQ";
    
    mapboxgl.accessToken = MAPBOX_TOKEN;

    let map = null;
    let allData = [];
    let markers = [];
    let currentCategory = "all";
    let currentView = "map"; // "map" or "list"
    let listSortState = { column: null, direction: null };
    let tableSortState = { column: null, direction: null };
    let speedRange = { min: 0, max: 1000 };
    let dataMap = new Map(); // Map row data to markers for click-to-fly
    let highlightedMarker = null;
    let geoJsonSource = null;
    let mapListenersAdded = false;

    // ─────────────────────────────────────────────────────────────
    // Utilities
    // ─────────────────────────────────────────────────────────────
    function toNumber(value) {
      if (value == null) return null;
      const n = Number(String(value).replace(/,/g, ""));
      return Number.isFinite(n) ? n : null;
    }

    function formatNumber(value) {
      if (value === null) return "";
      return new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(value);
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return dateString;
      return `${d.getMonth() + 1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
    }

    function parseDate(dateString) {
      const d = new Date(dateString);
      return isNaN(d.getTime()) ? null : d;
    }

    function getSpeedColor(download) {
      if (download >= 100) return "#22c55e";
      if (download >= 50) return "#84cc16";
      if (download >= 25) return "#eab308";
      if (download >= 10) return "#f97316";
      return "#ef4444";
    }

    function getCategories(data) {
      const categories = new Set(data.map(row => row.Category).filter(Boolean));
      return Array.from(categories).sort();
    }

    function isAirlineCategory(category) {
      return category === "Airline";
    }

    // ─────────────────────────────────────────────────────────────
    // Data filtering & sorting
    // ─────────────────────────────────────────────────────────────
    function filterData(data, category, speedFilter = null) {
      let filtered = data;
      
      if (category === "all") {
        filtered = data.filter(row => row.Category !== "Airline" && row.Latitude != null && row.Longitude != null);
      } else if (isAirlineCategory(category)) {
        filtered = data.filter(row => row.Category === "Airline");
      } else {
        filtered = data.filter(row => row.Category === category && row.Latitude != null && row.Longitude != null);
      }

      // Apply speed filter if provided
      if (speedFilter) {
        filtered = filtered.filter(row => {
          const download = toNumber(row["Download (Mbps)"]) || 0;
          return download >= speedFilter.min && download <= speedFilter.max;
        });
      }

      return filtered;
    }

    function sortData(data, column, direction) {
      if (!column) {
        return [...data].sort((a, b) => {
          const dateA = parseDate(a["Date Measured"]);
          const dateB = parseDate(b["Date Measured"]);
          if (!dateA && !dateB) return 0;
          if (!dateA) return 1;
          if (!dateB) return -1;
          return dateB - dateA;
        });
      }

      const numericColumns = ["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"];
      const isNumeric = numericColumns.includes(column);

      return [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        if (isNumeric) {
          valA = toNumber(valA);
          valB = toNumber(valB);
          if (valA === null && valB === null) return 0;
          if (valA === null) return 1;
          if (valB === null) return -1;
        } else {
          valA = valA || "";
          valB = valB || "";
        }

        if (valA < valB) return direction === "asc" ? -1 : 1;
        if (valA > valB) return direction === "asc" ? 1 : -1;
        return 0;
      });
    }

    // ─────────────────────────────────────────────────────────────
    // Map functions
    // ─────────────────────────────────────────────────────────────
    function clearMarkers() {
      markers.forEach(m => m.remove());
      markers = [];
      dataMap.clear();
      if (highlightedMarker) {
        highlightedMarker = null;
      }
      // Remove clustering source and layers if they exist
      if (map.getSource('wifi-points')) {
        if (map.getLayer('wifi-clusters')) map.removeLayer('wifi-clusters');
        if (map.getLayer('wifi-cluster-count')) map.removeLayer('wifi-cluster-count');
        if (map.getLayer('wifi-unclustered-point')) map.removeLayer('wifi-unclustered-point');
        map.removeSource('wifi-points');
      }
    }

    function createPopupHTML(row) {
      const download = toNumber(row["Download (Mbps)"]) || 0;
      const upload = toNumber(row["Upload (Mbps)"]) || 0;
      const latency = toNumber(row["Latency (ms)"]);
      const nameHtml = row.Website 
        ? `<a href="${row.Website}" target="_blank" rel="noopener noreferrer">${row.Name || "Unknown"}</a>`
        : (row.Name || "Unknown");
      const categoryBadge = row.Category 
        ? `<div class="popup-category">${row.Category}</div>`
        : "";
      const providerInfo = row.Provider 
        ? `<div class="popup-provider">Provider: ${row.Provider}</div>`
        : "";

      return `
        <div class="popup-name">${nameHtml}</div>
        ${categoryBadge}
        <div>${row.Address || ""}</div>
        <div class="popup-speed">↓ ${formatNumber(download)} Mbps</div>
        <div>↑ ${formatNumber(upload)} Mbps</div>
        <div>Latency: ${latency !== null ? formatNumber(latency) + " ms" : "N/A"}</div>
        ${providerInfo}
        <div style="color: #666; font-size: 11px; margin-top: 4px;">${formatDate(row["Date Measured"])}</div>
      `;
    }

    function addMarkers(data) {
      if (!map || !map.loaded()) {
        // If map isn't loaded yet, wait for it
        if (map) {
          map.once('load', () => addMarkers(data));
        }
        return;
      }

      clearMarkers();
      const bounds = new mapboxgl.LngLatBounds();

      // Create GeoJSON for clustering
      const features = [];
      const rowToFeatureMap = new Map();

      data.forEach(row => {
        const lat = toNumber(row.Latitude);
        const lng = toNumber(row.Longitude);
        if (lat === null || lng === null) return;

        const download = toNumber(row["Download (Mbps)"]) || 0;
        const color = getSpeedColor(download);

        const feature = {
          type: 'Feature',
          properties: {
            download: download,
            color: color,
            rowData: row
          },
          geometry: {
            type: 'Point',
            coordinates: [lng, lat]
          }
        };

        features.push(feature);
        rowToFeatureMap.set(row, feature);
        bounds.extend([lng, lat]);
      });

      if (features.length === 0) return;

      // Add source with clustering
      map.addSource('wifi-points', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: features
        },
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      // Add cluster circles
      map.addLayer({
        id: 'wifi-clusters',
        type: 'circle',
        source: 'wifi-points',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#2563eb',
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,
            10, 30,
            30, 40,
            100, 50
          ]
        }
      });

      // Add cluster count labels
      map.addLayer({
        id: 'wifi-cluster-count',
        type: 'symbol',
        source: 'wifi-points',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': '{point_count_abbreviated}',
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 12
        },
        paint: {
          'text-color': '#fff'
        }
      });

      // Add unclustered points
      map.addLayer({
        id: 'wifi-unclustered-point',
        type: 'circle',
        source: 'wifi-points',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': ['get', 'color'],
          'circle-radius': 8,
          'circle-stroke-width': 2,
          'circle-stroke-color': '#fff'
        }
      });

      // Add event listeners only once
      if (!mapListenersAdded) {
        // Click on cluster to zoom in
        map.on('click', 'wifi-clusters', (e) => {
          const features = map.queryRenderedFeatures(e.point, {
            layers: ['wifi-clusters']
          });
          if (features.length === 0) return;
          const clusterId = features[0].properties.cluster_id;
          map.getSource('wifi-points').getClusterExpansionZoom(clusterId, (err, zoom) => {
            if (err) return;
            map.easeTo({
              center: features[0].geometry.coordinates,
              zoom: zoom
            });
          });
        });

        // Click on point to show popup
        map.on('click', 'wifi-unclustered-point', (e) => {
          if (e.features.length === 0) return;
          const row = e.features[0].properties.rowData;
          const coordinates = e.features[0].geometry.coordinates.slice();
          const popup = new mapboxgl.Popup({ offset: 12 })
            .setLngLat(coordinates)
            .setHTML(createPopupHTML(row))
            .addTo(map);
        });

        // Change cursor on hover
        map.on('mouseenter', 'wifi-clusters', () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'wifi-clusters', () => {
          map.getCanvas().style.cursor = '';
        });
        map.on('mouseenter', 'wifi-unclustered-point', () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'wifi-unclustered-point', () => {
          map.getCanvas().style.cursor = '';
        });

        mapListenersAdded = true;
      }

      // Store row to feature mapping for click-to-fly
      data.forEach(row => {
        const feature = rowToFeatureMap.get(row);
        if (feature) {
          const marker = {
            getElement: () => null,
            togglePopup: () => {
              const popup = new mapboxgl.Popup({ offset: 12 })
                .setLngLat(feature.geometry.coordinates)
                .setHTML(createPopupHTML(row))
                .addTo(map);
            }
          };
          dataMap.set(row, marker);
        }
      });

      if (data.length > 0) {
        map.fitBounds(bounds, { padding: 40, maxZoom: 12 });
      }
    }

    function flyToLocation(row) {
      const lat = toNumber(row.Latitude);
      const lng = toNumber(row.Longitude);
      if (lat === null || lng === null) return;

      // Switch to map view if in list view
      if (currentView !== "map") {
        currentView = "map";
        updateViewToggle();
        updateView();
        // Wait for map to update before flying
        setTimeout(() => flyToLocation(row), 100);
        return;
      }

      // Fly to location
      map.flyTo({
        center: [lng, lat],
        zoom: 15,
        duration: 1000
      });

      // Show popup after fly animation
      setTimeout(() => {
        const popup = new mapboxgl.Popup({ offset: 12 })
          .setLngLat([lng, lat])
          .setHTML(createPopupHTML(row))
          .addTo(map);
      }, 1100);
    }

    async function searchLocation(query) {
      if (!query) {
        const filtered = filterData(allData, currentCategory, speedRange);
        if (currentView === "map") {
          addMarkers(filtered);
        }
        return;
      }

      try {
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&limit=1`
        );
        const result = await response.json();

        if (result.features && result.features.length > 0) {
          const [lng, lat] = result.features[0].center;
          
          if (currentView === "map") {
            map.flyTo({ center: [lng, lat], zoom: 11 });
          } else {
            // For list view, we could filter by proximity - for now just switch to map
            currentView = "map";
            updateViewToggle();
            updateView();
            map.flyTo({ center: [lng, lat], zoom: 11 });
          }
        }
      } catch (err) {
        console.error("Geocoding error:", err);
      }
    }

    // ─────────────────────────────────────────────────────────────
    // List view (for location-based data)
    // ─────────────────────────────────────────────────────────────
    function renderList(data) {
      const listContainer = document.getElementById("wifi-list");
      const columns = ["Name", "Category", "Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Date Measured"];
      
      const sortedData = sortData(data, listSortState.column, listSortState.direction);

      const table = document.createElement("table");
      
      // Header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      columns.forEach(col => {
        const th = document.createElement("th");
        th.dataset.column = col;
        
        const text = document.createElement("span");
        text.textContent = col;
        th.appendChild(text);

        const indicator = document.createElement("span");
        indicator.className = "sort-indicator";
        indicator.textContent = "⇅";
        th.appendChild(indicator);

        if (listSortState.column === col) {
          th.classList.add("sorted");
          indicator.textContent = listSortState.direction === "asc" ? "↑" : "↓";
        }

        th.addEventListener("click", () => {
          if (listSortState.column === col) {
            if (listSortState.direction === "asc") {
              listSortState.direction = "desc";
            } else {
              listSortState = { column: null, direction: null };
            }
          } else {
            listSortState = { column: col, direction: "asc" };
          }
          renderList(data);
        });

        headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement("tbody");
      
      sortedData.forEach(row => {
        const tr = document.createElement("tr");
        tr.dataset.rowData = JSON.stringify(row);
        tr.addEventListener("click", () => {
          flyToLocation(row);
        });
        
        columns.forEach(col => {
          const td = document.createElement("td");
          
          if (col === "Name") {
            const download = toNumber(row["Download (Mbps)"]) || 0;
            const dot = document.createElement("span");
            dot.className = "speed-dot";
            dot.style.backgroundColor = getSpeedColor(download);
            td.appendChild(dot);
            
            if (row.Website) {
              const a = document.createElement("a");
              a.href = row.Website;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.textContent = row[col] || "";
              a.onclick = (e) => e.stopPropagation(); // Prevent row click when clicking link
              td.appendChild(a);
            } else {
              td.appendChild(document.createTextNode(row[col] || ""));
            }
          } else if (col === "Date Measured") {
            td.textContent = formatDate(row[col]);
          } else if (["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"].includes(col)) {
            const val = toNumber(row[col]);
            td.textContent = val !== null ? formatNumber(val) : "N/A";
          } else {
            td.textContent = row[col] || "";
          }
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      
      listContainer.innerHTML = "";
      listContainer.appendChild(table);
    }

    // ─────────────────────────────────────────────────────────────
    // Airline table
    // ─────────────────────────────────────────────────────────────
    function renderTable(data) {
      const tableContainer = document.getElementById("wifi-table");
      const columns = ["Airline", "Route", "Aircraft Type", "Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Date Measured"];
      
      const sortedData = sortData(data, tableSortState.column, tableSortState.direction);

      const table = document.createElement("table");
      
      // Header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      columns.forEach(col => {
        const th = document.createElement("th");
        th.dataset.column = col;
        
        const text = document.createElement("span");
        text.textContent = col;
        th.appendChild(text);

        const indicator = document.createElement("span");
        indicator.className = "sort-indicator";
        indicator.textContent = "⇅";
        th.appendChild(indicator);

        if (tableSortState.column === col) {
          th.classList.add("sorted");
          indicator.textContent = tableSortState.direction === "asc" ? "↑" : "↓";
        }

        th.addEventListener("click", () => {
          if (tableSortState.column === col) {
            if (tableSortState.direction === "asc") {
              tableSortState.direction = "desc";
            } else {
              tableSortState = { column: null, direction: null };
            }
          } else {
            tableSortState = { column: col, direction: "asc" };
          }
          renderTable(data);
        });

        headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement("tbody");
      
      sortedData.forEach(row => {
        const tr = document.createElement("tr");
        
        columns.forEach(col => {
          const td = document.createElement("td");
          
          if (col === "Airline" && row.Website) {
            const a = document.createElement("a");
            a.href = row.Website;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = row[col] || "";
            td.appendChild(a);
          } else if (col === "Date Measured") {
            td.textContent = formatDate(row[col]);
          } else if (["Download (Mbps)", "Upload (Mbps)", "Latency (ms)", "Jitter (ms)"].includes(col)) {
            const val = toNumber(row[col]);
            td.textContent = val !== null ? formatNumber(val) : "N/A";
          } else {
            td.textContent = row[col] || "";
          }
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      
      tableContainer.innerHTML = "";
      tableContainer.appendChild(table);
    }

    // ─────────────────────────────────────────────────────────────
    // View switching
    // ─────────────────────────────────────────────────────────────
    function updateViewToggle() {
      const mapBtn = document.getElementById("view-map-btn");
      const listBtn = document.getElementById("view-list-btn");
      
      if (mapBtn && listBtn) {
        mapBtn.classList.toggle("active", currentView === "map");
        listBtn.classList.toggle("active", currentView === "list");
      }
    }

    function updateView() {
      const mapEl = document.getElementById("wifi-map");
      const listEl = document.getElementById("wifi-list");
      const tableEl = document.getElementById("wifi-table");
      const searchWrapper = document.querySelector(".search-wrapper");
      const viewToggleWrapper = document.querySelector(".view-toggle-wrapper");
      const legendEl = document.getElementById("speed-legend");
      const speedFilterWrapper = document.getElementById("speed-range-filter");
      
      const filtered = filterData(allData, currentCategory, speedRange);

      // Update statistics
      updateStatistics(filtered);

      if (isAirlineCategory(currentCategory)) {
        // Airline view: show table only
        mapEl.classList.add("hidden");
        listEl.classList.remove("visible");
        tableEl.classList.add("visible");
        searchWrapper?.classList.add("hidden");
        viewToggleWrapper?.classList.add("hidden");
        if (legendEl) legendEl.classList.add("hidden");
        if (speedFilterWrapper) speedFilterWrapper.style.display = "none";
        clearMarkers();
        renderTable(filtered);
      } else {
        // Location-based view: show map or list
        tableEl.classList.remove("visible");
        searchWrapper?.classList.remove("hidden");
        viewToggleWrapper?.classList.remove("hidden");
        if (legendEl) legendEl.classList.remove("hidden");
        if (speedFilterWrapper) speedFilterWrapper.style.display = "flex";
        
        if (currentView === "map") {
          mapEl.classList.remove("hidden");
          listEl.classList.remove("visible");
          addMarkers(filtered);
        } else {
          mapEl.classList.add("hidden");
          listEl.classList.add("visible");
          clearMarkers();
          renderList(filtered);
        }
      }
    }

    function updateStatistics(data) {
      const statsPanel = document.getElementById("statistics-panel");
      if (!statsPanel) return;

      const locationData = data.filter(row => row.Latitude != null && row.Longitude != null);
      const downloads = locationData.map(row => toNumber(row["Download (Mbps)"])).filter(v => v !== null);
      const uploads = locationData.map(row => toNumber(row["Upload (Mbps)"])).filter(v => v !== null);

      const avgDownload = downloads.length > 0 
        ? downloads.reduce((a, b) => a + b, 0) / downloads.length 
        : 0;
      const avgUpload = uploads.length > 0 
        ? uploads.reduce((a, b) => a + b, 0) / uploads.length 
        : 0;
      const maxDownload = downloads.length > 0 ? Math.max(...downloads) : 0;
      const minDownload = downloads.length > 0 ? Math.min(...downloads) : 0;

      statsPanel.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">Total Locations</div>
          <div class="stat-value">${locationData.length}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Download</div>
          <div class="stat-value">${formatNumber(avgDownload)} Mbps</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Upload</div>
          <div class="stat-value">${formatNumber(avgUpload)} Mbps</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Fastest</div>
          <div class="stat-value">${formatNumber(maxDownload)} Mbps</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Slowest</div>
          <div class="stat-value">${formatNumber(minDownload)} Mbps</div>
        </div>
      `;
    }

    function createSpeedLegend() {
      const legend = document.getElementById("speed-legend");
      if (!legend) return;

      legend.innerHTML = `
        <h3>Download Speed</h3>
        <div class="legend-item">
          <div class="legend-dot" style="background-color: #22c55e;"></div>
          <span>≥ 100 Mbps</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background-color: #84cc16;"></div>
          <span>50 - 99 Mbps</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background-color: #eab308;"></div>
          <span>25 - 49 Mbps</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background-color: #f97316;"></div>
          <span>10 - 24 Mbps</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background-color: #ef4444;"></div>
          <span>&lt; 10 Mbps</span>
        </div>
      `;
    }

    function createSpeedRangeFilter() {
      const controls = document.getElementById("wifi-controls");
      if (!controls) return;

      const speedFilterWrapper = document.createElement("div");
      speedFilterWrapper.id = "speed-range-filter";
      speedFilterWrapper.style.display = "none"; // Hidden by default, shown for location-based views

      const label = document.createElement("label");
      label.textContent = "Speed: ";
      label.style.fontWeight = "500";

      const minInput = document.createElement("input");
      minInput.type = "range";
      minInput.min = "0";
      minInput.max = "500";
      minInput.value = "0";
      minInput.id = "speed-min";

      const maxInput = document.createElement("input");
      maxInput.type = "range";
      maxInput.min = "0";
      maxInput.max = "500";
      maxInput.value = "500";
      maxInput.id = "speed-max";

      const valuesDisplay = document.createElement("div");
      valuesDisplay.className = "range-values";
      valuesDisplay.textContent = "0 - 500+ Mbps";

      function updateSpeedFilter() {
        const min = parseInt(minInput.value);
        const max = parseInt(maxInput.value);
        
        // Ensure min <= max
        if (min > max) {
          if (minInput === document.activeElement) {
            maxInput.value = min;
          } else {
            minInput.value = max;
          }
        }

        const finalMin = parseInt(minInput.value);
        const finalMax = parseInt(maxInput.value);
        speedRange = { min: finalMin, max: finalMax === 500 ? 1000 : finalMax };
        
        valuesDisplay.textContent = `${finalMin} - ${finalMax === 500 ? "500+" : finalMax} Mbps`;
        updateView();
      }

      minInput.addEventListener("input", updateSpeedFilter);
      maxInput.addEventListener("input", updateSpeedFilter);

      speedFilterWrapper.appendChild(label);
      speedFilterWrapper.appendChild(minInput);
      speedFilterWrapper.appendChild(maxInput);
      speedFilterWrapper.appendChild(valuesDisplay);

      // Insert after category filter
      const categoryFilter = document.getElementById("category-filter");
      if (categoryFilter && categoryFilter.parentElement) {
        categoryFilter.parentElement.parentElement.insertBefore(speedFilterWrapper, categoryFilter.parentElement.nextSibling);
      } else {
        controls.appendChild(speedFilterWrapper);
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Controls
    // ─────────────────────────────────────────────────────────────
    function createControls(categories) {
      const controls = document.getElementById("wifi-controls");
      
      // Category filter
      const filterLabel = document.createElement("label");
      filterLabel.textContent = "Filter: ";
      const select = document.createElement("select");
      select.id = "category-filter";

      const allOption = document.createElement("option");
      allOption.value = "all";
      allOption.textContent = "All";
      select.appendChild(allOption);

      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });

      select.addEventListener("change", (e) => {
        currentCategory = e.target.value;
        listSortState = { column: null, direction: null };
        tableSortState = { column: null, direction: null };
        speedRange = { min: 0, max: 1000 }; // Reset speed filter
        const minInput = document.getElementById("speed-min");
        const maxInput = document.getElementById("speed-max");
        if (minInput) minInput.value = "0";
        if (maxInput) maxInput.value = "500";
        if (!isAirlineCategory(currentCategory)) {
          currentView = "map"; // Reset to map when switching categories
        }
        updateViewToggle();
        updateView();
      });

      filterLabel.appendChild(select);
      controls.appendChild(filterLabel);

      // View toggle (Map / List)
      const viewToggleWrapper = document.createElement("div");
      viewToggleWrapper.className = "view-toggle-wrapper";
      
      const viewToggle = document.createElement("div");
      viewToggle.className = "view-toggle";
      
      const mapBtn = document.createElement("button");
      mapBtn.id = "view-map-btn";
      mapBtn.textContent = "Map";
      mapBtn.className = "active";
      mapBtn.addEventListener("click", () => {
        if (currentView !== "map") {
          currentView = "map";
          updateViewToggle();
          updateView();
        }
      });
      
      const listBtn = document.createElement("button");
      listBtn.id = "view-list-btn";
      listBtn.textContent = "List";
      listBtn.addEventListener("click", () => {
        if (currentView !== "list") {
          currentView = "list";
          updateViewToggle();
          updateView();
        }
      });
      
      viewToggle.appendChild(mapBtn);
      viewToggle.appendChild(listBtn);
      viewToggleWrapper.appendChild(viewToggle);
      controls.appendChild(viewToggleWrapper);

      // Search input
      const searchWrapper = document.createElement("div");
      searchWrapper.className = "search-wrapper";
      
      const searchLabel = document.createElement("label");
      searchLabel.textContent = "Search: ";
      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = "City or zip code...";
      searchInput.id = "location-search";

      let debounceTimer;
      searchInput.addEventListener("input", (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchLocation(e.target.value.trim());
        }, 400);
      });

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          clearTimeout(debounceTimer);
          searchLocation(e.target.value.trim());
        }
      });

      searchLabel.appendChild(searchInput);
      searchWrapper.appendChild(searchLabel);
      controls.appendChild(searchWrapper);
    }

    // ─────────────────────────────────────────────────────────────
    // Initialize
    // ─────────────────────────────────────────────────────────────
    try {
      const response = await fetch(DATA_URL + "?t=" + Date.now(), { cache: "no-store" });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      allData = await response.json();

      map = new mapboxgl.Map({
        container: "wifi-map",
        style: "mapbox://styles/mapbox/light-v11",
        center: [0, 20],
        zoom: 1
      });

      map.addControl(new mapboxgl.NavigationControl(), "top-right");

      createControls(getCategories(allData));
      createSpeedRangeFilter();
      createSpeedLegend();

      // Wait for map to load before adding sources
      map.on('load', () => {
        updateView();
      });

    } catch (err) {
      document.getElementById("wifi-map").textContent = `Error: ${err.message}`;
    }
  })();
  </script>
</body>
</html>

